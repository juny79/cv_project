# ===============================================================
# ğŸš€ layout_gate8_exploit.yaml
# ëª©í‘œ: leaderboard 0.98+ (ê³µê²©ì  post-hoc fusion)
# ===============================================================

seed: 42
device: auto
num_workers: 2

paths:
  base_dir: /root/cv_project/data
  train_csv: /root/cv_project/data/train.csv
  sample_csv: /root/cv_project/data/sample_submission.csv
  train_dir: /root/cv_project/data/train
  test_dir: /root/cv_project/data/test
  out_dir: /root/cv_project/outputs/layout_gate8

data:
  img_size: 640
  folds: [0,1,2,3,4]
  n_splits: 5
  tta: 8              # â¬† 45Â° í¬í•¨ 8ë°©í–¥ TTAë¡œ ì˜ˆì¸¡ ë‹¤ì–‘ì„± ê°•í™”
  aug_multiplier: 8

model:
  name: convnext_tiny.fb_in22k_ft_in1k
  pretrained: true
  dropout: 0.1
  label_smoothing: 0.05

train:
  epochs: 12
  batch_size: 32
  lr: 3e-4
  weight_decay: 1e-4
  scheduler: cosine
  early_stop_patience: 3
  amp: true
  mixup_alpha: 0.2
  cutmix_alpha: 0.2     # â¬† ê³µê²©ì ìœ¼ë¡œ í™œì„±í™”
  grad_clip: 1.0
  class_weight: balanced

log:
  use_wandb: false
  use_mlflow: false

# ===============================================================
# ğŸ”¹ Inference / Preprocessing
# ===============================================================
inference:
  amp: true
  batch_size: 32
  preproc_variants:
    enable: true
    combine: max_conf
    variants:
      - { name: base,   clahe_clip: 1.9, unsharp_amount: 0.5, deskew: true,  gamma: 1.00 }
      - { name: mild,   clahe_clip: 1.6, unsharp_amount: 0.3, deskew: true,  gamma: 0.95 }
      - { name: strong, clahe_clip: 2.2, unsharp_amount: 0.7, deskew: true,  gamma: 1.05 }

# ===============================================================
# ğŸ”¹ Easy-Lock (Option 1b: add 11/12, tighten thresholds)
# ===============================================================
ensemble:
  easy_classes: [1,14,13,8,10,5,0]
  easy_conf: 0.95
  easy_conf_map: { "1":0.95, "14":0.95, "13":0.95, "8":0.95, "10":0.95, "5":0.95, "0":0.95 }

# ===============================================================
# ğŸ”¹ Meta-Gate (ë¶ˆí™•ì‹¤ êµ¬ê°„ í™•ëŒ€)
# ===============================================================
meta_gate:
  entropy_thr: 1.3          # â¬‡ ë” ë„“ì€ ë²”ìœ„ì— meta ì ìš© (ì™„í™”)
  margin_thr: 0.15           # â¬† top2 í™•ë¥  ê·¼ì ‘ ì‹œ ë” ì ê·¹ ê°œì… (ì™„í™”)

# ===============================================================
# ğŸ”¹ Advanced Postprocess (risk-focused flips for 3/7)
#  - ë‚®ì€ margin + ì¤‘ê°„ entropy + top1_conf ë‚®ì€ ìƒ˜í”Œì—ì„œ 2nd-bestë¡œ ë’¤ì§‘ê¸° ì‹œë„
#  - easy lock ëœ ê³ í™•ì‹  ìƒ˜í”Œì€ ì œì™¸
# ===============================================================
postprocess:
  enable: true
  class_a: 3
  class_b: 7
  delta_threshold: 0.04
  confidence_threshold: 0.55
  prefer: higher
  advanced_flip:
    enable: true
    target_classes: [3,7,4,14]
    margin_thr: 0.08          # top1-top2 ì¢ì€ ê²½ìš°ë§Œ (ì™„í™”)
    entropy_thr: 0.25         # ë„ˆë¬´ ë‚®ì€ entropy(ì´ë¯¸ í™•ì‹ ) ì œì™¸ (ì™„í™”)
    top1_conf_max: 0.96       # í™•ì‹ ì´ ê³¼ë„í•˜ê²Œ ë†’ì€ ê²½ìš° ì œì™¸ (ì™„í™”)
    second_gain_min: 0.025    # 2nd-bestê°€ top1ì— ë§¤ìš° ê·¼ì ‘ (ì™„í™”)

# ===============================================================
# ğŸ”¹ OCR Keyword Routing (ê³µê²©ì )
# ===============================================================
text_routing:
  enable: false
  source: /root/cv_project/extern/ocr_text.csv
  pairs: [[3,7], [4,14]]
  delta_thr_strict: 0.06
  conf_thr_strict: 0.50
  min_hits_strict: 2
  delta_thr_wide: 0.10
  conf_thr_wide: 0.45
  min_hits_wide: 2
  entropy_thr_wide: 1.3
  margin_thr_wide: 0.15
  prefer_top: true
  easy_exclude: true          # Easy-Lock ì¶©ì¡± ì‹œ ë¼ìš°íŒ… ì œì™¸ (ì¼ê´€ì„± ë³´ì¥)
  normalization:
    nfkc: true
    remove_spaces: true
    collapse_repeats: true
  debug:
    enable: true
    csv_path: /root/cv_project/outputs/exp_layout_gate8/ocr_debug.csv

# ===============================================================
# ğŸ”¹ Text-Gate (OCR ì—†ëŠ” ìƒ˜í”Œìš©)
# ===============================================================
text_gate:
  enable: true
  pairs: [[3,7], [4,14]]
  delta_thr: 0.12             # â¬† íŒë‹¨ ê²½ê³„ ì™„í™”
  conf_thr: 0.25              # â¬‡ ë‚®ì€ í™•ì‹ ë„ì—ë„ ê°œì… í—ˆìš©
  prefer_higher: true

# ===============================================================
# ğŸ”¹ LayoutLMv3 Refiner (í•µì‹¬ ê°•í™”)
# ===============================================================
layout_refiner:
  enable: true
  model_name: microsoft/layoutlmv3-base
  ckpt_dir_3_7: /root/cv_project/extern/layout_pair_3_7
  ckpt_dir_4_14: /root/cv_project/extern/layout_pair_4_14
  delta_thr: 0.08              # â¬† ë” ë„“ì€ ê·¼ì ‘ ë²”ìœ„ í—ˆìš©
  conf_thr: 0.50               # â¬‡ ë‚®ì€ í™•ì‹ ë„ì—ì„œë„ ê°œì…
  entropy_thr: 1.3             # â¬‡ ë¶ˆí™•ì‹¤ì„± ê¸°ì¤€ ì™„í™”
  margin_thr: 0.15             # â¬† top-2 ê·¼ì ‘ì‹œ refiner ì‘ë™
  ocr_backend: paddle
  ocr_min_word_len: 2
  max_words: 512
  use_title_roi: true
  title_ratio: 0.20
  debug_csv: /root/cv_project/outputs/exp_layout_gate8/layout_refiner_debug.csv

# ===============================================================
# ğŸ”¹ Pair-Gate (Meta+Layout ê²°í•©)
# ===============================================================
pair_gate:
  enable: true
  delta_thr: 0.07
  conf_thr: 0.50
  entropy_thr: 1.2
  margin_thr: 0.12


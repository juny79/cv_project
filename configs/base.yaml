seed: 42
device: auto            # auto|cuda|cpu
num_workers: 0          # 먼저 0으로 안정화 → 문제 없으면 2~4로 올리세요

paths:
  base_dir: /root/cv_project/data
  train_csv: /root/cv_project/data/train.csv
  sample_csv: /root/cv_project/data/sample_submission.csv
  train_dir: /root/cv_project/data/train
  test_dir: /root/cv_project/data/test
  out_dir: /root/cv_project/outputs/full_mult4

data:
  img_size: 640
  folds: [0,1,2,3,4]
  n_splits: 5
  tta: 4               # Test Time Augmentation (4-way rotation)
  aug_multiplier: 4    # repeat-augmentation multiplier for training (1 = off)

model:
  name: convnext_tiny.fb_in22k_ft_in1k   # timm 프리트레인 가중치 확실, 안정적
  pretrained: true
  dropout: 0.1
  label_smoothing: 0.05

train:
  epochs: 12
  batch_size: 32
  lr: 3e-4
  weight_decay: 1e-4
  scheduler: cosine     # cosine | onecycle | step
  early_stop_patience: 3
  amp: true             # 자동 혼합정밀
  mixup_alpha: 0.2      # 0이면 비활성 (문서에서 과하면 역효과)
  cutmix_alpha: 0.0     # 기본 off. 필요시 0.2
  grad_clip: 1.0
  class_weight: balanced   # 불균형 완화

log:
  use_wandb: false
  use_mlflow: false

inference:
  amp: true
  batch_size: 32
  # Optional: multiple deterministic preprocessing variants for test-time
  preproc_variants:
    enable: true
    combine: mean   # mean | max_conf
    variants:
      - { name: base, clahe_clip: 1.9, unsharp_amount: 0.5, deskew: true,  gamma: 1.00 }
      - { name: mild, clahe_clip: 1.6, unsharp_amount: 0.3, deskew: true,  gamma: 0.95 }
      - { name: strong, clahe_clip: 2.2, unsharp_amount: 0.7, deskew: true,  gamma: 1.05 }

ensemble:
  easy_classes: [0,2,5,8,9,15,16]
  easy_conf: 0.92
  easy_conf_map: { "0":0.90, "2":0.92, "5":0.92, "8":0.92, "9":0.90, "15":0.92, "16":0.92 }

meta_gate:
  entropy_thr: 1.4    # 엔트로피 상한 (이보다 크면 불확실)
  margin_thr: 0.10    # Top1 - Top2 마진 (이보다 작으면 불확실)

text_gate:
  enable: true
  pairs: [[3,7], [4,14]]  # 텍스트 보조 대상 클래스 쌍
  delta_thr: 0.08         # 확률 차이 임계치 (이보다 작으면 초근접)
  conf_thr: 0.35          # 최소 확신도 (둘 중 하나라도 이상이어야 함)
  prefer_higher: true     # true: 높은 확률 선택, false: 특정 규칙

pair_gate:
  enable: true
  pairs: [[3,7], [4,14]]  # 페어 리파이너 대상 쌍
  delta_thr: 0.05         # 확률 차이 (|p_a - p_b|)
  conf_thr: 0.55          # 둘 중 max(p_a,p_b) 최소값
  entropy_thr: 1.2        # 선택적: 엔트로피가 이보다 클 때만 (불확실)
  margin_thr: 0.12        # 선택적: top1-top2 마진 이보다 작을 때만

text_routing:
  enable: true
  source: /root/cv_project/extern/ocr_text.csv   # id, text 열이 있는 CSV (미존재 시 자동 건너뜀)
  pairs: [[3,7], [4,14]]
  delta_thr: 0.04     # |p_a - p_b| < 0.04 (초근접)
  conf_thr: 0.55      # max(p_a, p_b) > 0.55
  min_hits: 2         # 라우팅 채택에 필요한 키워드 히트 수
  prefer_top: true    # 동률이면 top-prob 쪽 유지
  # 추가 설정 (선택적)
  # extra_keywords: { "3": ["입원증명"], "7": ["외래접수"], "4": ["진단내역"], "14": ["의학적소견"] }
  # remove_keywords: { "3": ["퇴원확인서"] }
  # keyword_file: /root/cv_project/extern/keyword_patterns.csv   # columns: class,pattern
  # normalization:
  #   remove_punct: true
  #   remove_digits: true
  #   nfkc: true
  # debug:
  #   enable: true
  #   csv_path: /root/cv_project/outputs/keyword_routing_debug.csv
